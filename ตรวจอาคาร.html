<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจเช็คอาคารเรียน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-6 max-w-4xl">
        
        <!-- Header -->
        <header class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-center text-blue-600">ระบบตรวจเช็คอาคารเรียน</h1>
            <p class="text-center text-gray-500 mt-2">บันทึกและสรุปผลการตรวจสอบความเรียบร้อยของห้องเรียน</p>
        </header>

        <!-- Action Buttons -->
        <div class="flex justify-center mb-6 space-x-4">
            <button id="showSummaryBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                สรุปผลทั้งหมด
            </button>
            <button id="deleteAllBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 hidden">
                ลบทั้งหมด
            </button>
        </div>

        <!-- Report List -->
        <div id="reportList" class="space-y-4">
            <!-- Reports will be dynamically inserted here -->
            <div id="placeholder" class="text-center py-10 px-6 bg-white rounded-xl shadow-md">
                <p class="text-gray-500">ยังไม่มีรายงานการตรวจเช็ค</p>
                <p class="text-gray-400 text-sm mt-2">กดปุ่ม + ด้านล่างเพื่อเริ่มบันทึก</p>
            </div>
        </div>

        <!-- Footer Credit -->
        <footer class="text-center pt-8 pb-4 text-gray-500 text-sm">
            <p>พัฒนาโดย Famous Group โรงเรียนหนองไผ่</p>
        </footer>

    </div>

    <!-- Add Report Floating Button -->
    <button id="addReportBtn" class="fixed bottom-6 right-6 bg-blue-500 hover:bg-blue-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <!-- Add Report Modal -->
    <div id="addModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md transform transition-all scale-95 opacity-0" id="addModalContent">
            <h2 class="text-2xl font-bold mb-4">เพิ่มบันทึกการตรวจเช็ค</h2>
            <form id="addReportForm">
                <div class="mb-4">
                    <label for="roomSelect" class="block text-gray-700 font-medium mb-2">เลือกห้องเรียน</label>
                    <select id="roomSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="" disabled selected>-- กรุณาเลือกห้อง --</option>
                        <optgroup label="ชั้นมัธยมศึกษาปีที่ 1">
                            <option value="ม.1/1">ห้อง ม.1/1</option>
                            <option value="ม.1/2">ห้อง ม.1/2</option>
                            <option value="ม.1/3">ห้อง ม.1/3</option>
                            <option value="ม.1/4">ห้อง ม.1/4</option>
                            <option value="ม.1/5">ห้อง ม.1/5</option>
                            <option value="ม.1/6">ห้อง ม.1/6</option>
                            <option value="ม.1/7">ห้อง ม.1/7</option>
                            <option value="ม.1/8">ห้อง ม.1/8</option>
                            <option value="ม.1/9">ห้อง ม.1/9</option>
                            <option value="ม.1/10">ห้อง ม.1/10</option>
                        </optgroup>
                        <optgroup label="ชั้นมัธยมศึกษาปีที่ 2">
                            <option value="ม.2/1">ห้อง ม.2/1</option>
                            <option value="ม.2/2">ห้อง ม.2/2</option>
                            <option value="ม.2/3">ห้อง ม.2/3</option>
                            <option value="ม.2/4">ห้อง ม.2/4</option>
                            <option value="ม.2/5">ห้อง ม.2/5</option>
                            <option value="ม.2/6">ห้อง ม.2/6</option>
                            <option value="ม.2/7">ห้อง ม.2/7</option>
                            <option value="ม.2/8">ห้อง ม.2/8</option>
                            <option value="ม.2/9">ห้อง ม.2/9</option>
                            <option value="ม.2/10">ห้อง ม.2/10</option>
                        </optgroup>
                        <optgroup label="ชั้นมัธยมศึกษาปีที่ 3">
                            <option value="ม.3/1">ห้อง ม.3/1</option>
                            <option value="ม.3/2">ห้อง ม.3/2</option>
                            <option value="ม.3/3">ห้อง ม.3/3</option>
                            <option value="ม.3/4">ห้อง ม.3/4</option>
                            <option value="ม.3/5">ห้อง ม.3/5</option>
                            <option value="ม.3/6">ห้อง ม.3/6</option>
                            <option value="ม.3/7">ห้อง ม.3/7</option>
                            <option value="ม.3/8">ห้อง ม.3/8</option>
                            <option value="ม.3/9">ห้อง ม.3/9</option>
                            <option value="ม.3/10">ห้อง ม.3/10</option>
                        </optgroup>
                        <optgroup label="ชั้นมัธยมศึกษาปีที่ 4">
                            <option value="ม.4/1">ห้อง ม.4/1</option>
                            <option value="ม.4/2">ห้อง ม.4/2</option>
                            <option value="ม.4/3">ห้อง ม.4/3</option>
                            <option value="ม.4/4">ห้อง ม.4/4</option>
                            <option value="ม.4/5">ห้อง ม.4/5</option>
                            <option value="ม.4/6">ห้อง ม.4/6</option>
                            <option value="ม.4/7">ห้อง ม.4/7</option>
                            <option value="ม.4/8">ห้อง ม.4/8</option>
                            <option value="ม.4/9">ห้อง ม.4/9</option>
                            <option value="ม.4/10">ห้อง ม.4/10</option>
                        </optgroup>
                        <optgroup label="ชั้นมัธยมศึกษาปีที่ 5">
                            <option value="ม.5/1">ห้อง ม.5/1</option>
                            <option value="ม.5/2">ห้อง ม.5/2</option>
                            <option value="ม.5/3">ห้อง ม.5/3</option>
                            <option value="ม.5/4">ห้อง ม.5/4</option>
                            <option value="ม.5/5">ห้อง ม.5/5</option>
                            <option value="ม.5/6">ห้อง ม.5/6</option>
                            <option value="ม.5/7">ห้อง ม.5/7</option>
                            <option value="ม.5/8">ห้อง ม.5/8</option>
                            <option value="ม.5/9">ห้อง ม.5/9</option>
                            <option value="ม.5/10">ห้อง ม.5/10</option>
                        </optgroup>
                        <optgroup label="ชั้นมัธยมศึกษาปีที่ 6">
                            <option value="ม.6/1">ห้อง ม.6/1</option>
                            <option value="ม.6/2">ห้อง ม.6/2</option>
                            <option value="ม.6/3">ห้อง ม.6/3</option>
                            <option value="ม.6/4">ห้อง ม.6/4</option>
                            <option value="ม.6/5">ห้อง ม.6/5</option>
                            <option value="ม.6/6">ห้อง ม.6/6</option>
                            <option value="ม.6/7">ห้อง ม.6/7</option>
                            <option value="ม.6/8">ห้อง ม.6/8</option>
                            <option value="ม.6/9">ห้อง ม.6/9</option>
                            <option value="ม.6/10">ห้อง ม.6/10</option>
                        </optgroup>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="notes" class="block text-gray-700 font-medium mb-2">หมายเหตุ (สิ่งผิดปกติที่พบ)</label>
                    <textarea id="notes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น ไม่ปิดไฟ, ไม่ได้เอาคัทเอาท์ลง, หน้าต่างไม่ได้ล็อค" required></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelAddBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ยกเลิก</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Summary Modal -->
    <div id="summaryModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl transform transition-all scale-95 opacity-0" id="summaryModalContent">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">สรุปผลการตรวจเช็ค</h2>
                <button id="closeSummaryBtn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="summaryContent" class="max-h-96 overflow-y-auto space-y-4 p-4 mb-6 border rounded-lg bg-gray-50">
                <!-- Summary content will be dynamically inserted here -->
            </div>
            <div class="flex justify-end">
                <button id="downloadSummaryBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 transition-transform transform hover:scale-105">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>บันทึกเป็นรูปภาพ</span>
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const addReportBtn = document.getElementById('addReportBtn');
            const showSummaryBtn = document.getElementById('showSummaryBtn');
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            const addModal = document.getElementById('addModal');
            const addModalContent = document.getElementById('addModalContent');
            const summaryModal = document.getElementById('summaryModal');
            const summaryModalContent = document.getElementById('summaryModalContent');
            const cancelAddBtn = document.getElementById('cancelAddBtn');
            const closeSummaryBtn = document.getElementById('closeSummaryBtn');
            const addReportForm = document.getElementById('addReportForm');
            const reportList = document.getElementById('reportList');
            const placeholder = document.getElementById('placeholder');
            const roomSelect = document.getElementById('roomSelect');
            const notes = document.getElementById('notes');
            const summaryContent = document.getElementById('summaryContent');
            const downloadSummaryBtn = document.getElementById('downloadSummaryBtn');

            // --- Data Storage ---
            let reports = JSON.parse(localStorage.getItem('buildingReports')) || [];

            // --- Functions ---
            const renderReports = () => {
                reportList.innerHTML = ''; // Clear current list

                // Show or hide the "Delete All" button based on whether there are reports
                if (reports.length > 0) {
                    deleteAllBtn.classList.remove('hidden');
                } else {
                    deleteAllBtn.classList.add('hidden');
                }

                if (reports.length === 0) {
                    reportList.appendChild(placeholder);
                } else {
                     // Sort reports by room number
                    const sortedReports = [...reports].sort((a, b) => a.room.localeCompare(b.room, 'th-TH-u-kn-true'));

                    sortedReports.forEach((report) => {
                        const reportCard = document.createElement('div');
                        reportCard.className = 'bg-white rounded-xl shadow-md p-5 transition-transform transform hover:scale-102';
                        reportCard.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-blue-500 font-semibold">${new Date(report.timestamp).toLocaleString('th-TH')}</p>
                                    <h3 class="text-xl font-bold text-gray-800">ห้อง ${report.room}</h3>
                                    <p class="text-gray-600 mt-2">${report.notes}</p>
                                </div>
                                <button data-index="${report.id}" class="delete-btn text-gray-400 hover:text-red-500 text-2xl leading-none">&times;</button>
                            </div>
                        `;
                        reportList.appendChild(reportCard);
                    });
                }
            };
            
            const saveToLocalStorage = () => {
                localStorage.setItem('buildingReports', JSON.stringify(reports));
            };
            
            const openModal = (modal, content) => {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                }, 10);
            };

            const closeModal = (modal, content) => {
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            };

            const generateSummary = () => {
                if (reports.length === 0) {
                    summaryContent.innerHTML = '<p class="text-gray-500 text-center">ยังไม่มีข้อมูลสำหรับสรุปผล</p>';
                    return;
                }

                const summary = reports.reduce((acc, report) => {
                    if (!acc[report.room]) {
                        acc[report.room] = [];
                    }
                    acc[report.room].push(report.notes);
                    return acc;
                }, {});

                summaryContent.innerHTML = ''; // Clear previous summary

                // Add date and time header
                const now = new Date();
                const dateTimeString = now.toLocaleString('th-TH', { dateStyle: 'long', timeStyle: 'medium' });
                const headerDiv = document.createElement('div');
                headerDiv.className = 'text-center mb-4 pb-4 border-b';
                headerDiv.innerHTML = `
                    <p class="font-bold text-lg text-gray-700">สรุปผล ณ วันที่</p>
                    <p class="text-gray-600">${dateTimeString}</p>
                `;
                summaryContent.appendChild(headerDiv);

                // Add room details
                Object.keys(summary).sort((a, b) => a.localeCompare(b, 'th-TH-u-kn-true')).forEach(room => {
                    const roomDiv = document.createElement('div');
                    roomDiv.className = 'bg-white p-4 rounded-lg shadow-sm';
                    
                    let notesList = summary[room].map(note => `<li class="text-gray-700">${note}</li>`).join('');

                    roomDiv.innerHTML = `
                        <h4 class="text-lg font-bold text-blue-700">ห้อง ${room}</h4>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            ${notesList}
                        </ul>
                    `;
                    summaryContent.appendChild(roomDiv);
                });
            };


            // --- Event Listeners ---
            addReportBtn.addEventListener('click', () => {
                addReportForm.reset();
                openModal(addModal, addModalContent);
            });

            cancelAddBtn.addEventListener('click', () => closeModal(addModal, addModalContent));
            
            addReportForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newReport = {
                    id: Date.now(),
                    room: roomSelect.value,
                    notes: notes.value,
                    timestamp: new Date().toISOString()
                };
                reports.push(newReport);
                saveToLocalStorage();
                renderReports();
                closeModal(addModal, addModalContent);
            });

            showSummaryBtn.addEventListener('click', () => {
                generateSummary();
                openModal(summaryModal, summaryModalContent);
            });

            deleteAllBtn.addEventListener('click', () => {
                // NOTE: In a real-world app, a custom confirmation modal would be ideal here instead of a direct action.
                // As per instructions, window.confirm() is avoided.
                reports = [];
                saveToLocalStorage();
                renderReports();
            });
            
            closeSummaryBtn.addEventListener('click', () => closeModal(summaryModal, summaryModalContent));
            
            addModal.addEventListener('click', (e) => {
                if (e.target === addModal) closeModal(addModal, addModalContent);
            });
            summaryModal.addEventListener('click', (e) => {
                if (e.target === summaryModal) closeModal(summaryModal, summaryModalContent);
            });
            
            reportList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const reportId = parseInt(e.target.dataset.index);
                    reports = reports.filter(report => report.id !== reportId);
                    saveToLocalStorage();
                    renderReports();
                }
            });

            downloadSummaryBtn.addEventListener('click', () => {
                // Temporarily remove scrolling and height limits to capture the full content
                summaryContent.classList.remove('max-h-96', 'overflow-y-auto');

                // Use html2canvas to capture the summaryContent div
                html2canvas(summaryContent, {
                    scale: 2, // Increase resolution for better quality
                    backgroundColor: '#f9fafb' // Set a background color for the image
                }).then(canvas => {
                    const link = document.createElement('a');
                    const date = new Date().toISOString().split('T')[0];
                    link.download = `สรุปผลการตรวจเช็ค-${date}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    // Restore the original classes after the capture is done
                    summaryContent.classList.add('max-h-96', 'overflow-y-auto');
                }).catch(err => {
                    console.error("เกิดข้อผิดพลาดในการสร้างรูปภาพ:", err);
                    // Ensure the classes are restored even if an error occurs
                    summaryContent.classList.add('max-h-96', 'overflow-y-auto');
                });
            });

            // Initial Render
            renderReports();
        });
    </script>
</body>
</html>



