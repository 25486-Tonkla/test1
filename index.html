<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แอปเก็บงาน</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts for Thai language -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Custom styles for smooth transitions and dark mode */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .task-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, opacity 0.3s;
        }
        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .task-done {
            opacity: 0.6;
        }
        .task-done .task-title {
            text-decoration: line-through;
        }
        /* Custom Checkbox */
        .task-checkbox {
            appearance: none;
            background-color: transparent;
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid #ccc;
            border-radius: 0.375rem;
            cursor: pointer;
            display: inline-block;
            position: relative;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .dark .task-checkbox {
            border-color: #4a5568;
        }
        .task-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .task-checkbox:checked::after {
            content: '';
            position: absolute;
            left: 0.45rem;
            top: 0.15rem;
            width: 0.4rem;
            height: 0.8rem;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[200] flex items-center justify-center bg-gray-900 bg-opacity-60 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
    </div>

    <!-- Auth View (Login/Register) -->
    <div id="auth-view" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-100 dark:bg-gray-900 hidden">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <!-- Login Form -->
            <div id="login-form-container">
                <h2 class="text-2xl font-bold text-center">เข้าสู่ระบบ</h2>
                <form id="login-form" class="mt-6 space-y-4">
                    <div>
                        <label for="login-email" class="text-sm font-medium">อีเมล</label>
                        <input id="login-email" type="email" required class="w-full px-3 py-2 mt-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="email@example.com">
                    </div>
                    <div>
                        <label for="login-password" class="text-sm font-medium">รหัสผ่าน</label>
                        <input id="login-password" type="password" required class="w-full px-3 py-2 mt-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="••••••••">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300">เข้าสู่ระบบ</button>
                    <p class="text-sm text-center text-gray-600 dark:text-gray-400">
                        ยังไม่มีบัญชี? <button type="button" id="show-register-btn" class="font-medium text-blue-600 hover:underline">สมัครสมาชิก</button>
                    </p>
                </form>
            </div>
            <!-- Register Form -->
            <div id="register-form-container" class="hidden">
                <h2 class="text-2xl font-bold text-center">สมัครสมาชิก</h2>
                <form id="register-form" class="mt-6 space-y-4">
                    <div>
                        <label for="register-email" class="text-sm font-medium">อีเมล</label>
                        <input id="register-email" type="email" required class="w-full px-3 py-2 mt-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="email@example.com">
                    </div>
                    <div>
                        <label for="register-password" class="text-sm font-medium">รหัสผ่าน</label>
                        <input id="register-password" type="password" required class="w-full px-3 py-2 mt-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="••••••••">
                    </div>
                     <div>
                        <label for="register-confirm-password" class="text-sm font-medium">ยืนยันรหัสผ่าน</label>
                        <input id="register-confirm-password" type="password" required class="w-full px-3 py-2 mt-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="••••••••">
                    </div>
                    <div class="flex items-center">
                        <input id="register-terms" type="checkbox" required class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                        <label for="register-terms" class="ml-2 text-sm text-gray-900 dark:text-gray-300">ฉันยอมรับ <button type="button" id="open-terms-btn" class="font-medium text-blue-600 hover:underline">ข้อกำหนดและเงื่อนไข</button></label>
                    </div>
                    <button type="submit" id="register-submit-btn" class="w-full px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 disabled:bg-gray-400 dark:disabled:bg-gray-600 cursor-not-allowed" disabled>สมัครสมาชิก</button>
                    <p class="text-sm text-center text-gray-600 dark:text-gray-400">
                        มีบัญชีอยู่แล้ว? <button type="button" id="show-login-btn" class="font-medium text-blue-600 hover:underline">เข้าสู่ระบบ</button>
                    </p>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Main App Wrapper -->
    <div id="app-wrapper" class="hidden">
        <!-- View for Home Page (Task List & Calendar) -->
        <div id="home-view">
            <div id="calendar-wrapper" class="container mx-auto px-4 pt-6 hidden">
                 <!-- Calendar will be injected here by JS -->
            </div>
            <main id="task-list-container" class="container mx-auto px-4 pb-24 pt-2">
                <!-- Tasks will be rendered here -->
            </main>
            <button id="open-add-task-modal-btn" class="fixed bottom-20 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg z-30 transition-transform duration-200 hover:scale-110">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            </button>
        </div>

        <!-- View for Subject Selection Page -->
        <div id="subject-view" class="hidden">
            <main class="container mx-auto px-4 pb-24 pt-6">
                <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                    <input type="text" id="search-input" placeholder="ค้นหางานทั้งหมด..." class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4">
                    
                    <div>
                        <label for="subject-dropdown" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">เลือกวิชา</label>
                        <select id="subject-dropdown" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="all" selected>แสดงงานทั้งหมด</option>
                            <option value="ฟิสิกส์">ฟิสิกส์</option>
                            <option value="ภาษาไทย">ภาษาไทย</option>
                            <optgroup label="คณิตศาสตร์">
                                <option value="คณิตพื้นฐาน">คณิตพื้นฐาน</option>
                                <option value="คณิตเพิ่มเติม">คณิตเพิ่มเติม</option>
                            </optgroup>
                            <optgroup label="ภาษาอังกฤษ">
                                <option value="อังกฤษพื้นฐาน">อังกฤษพื้นฐาน</option>
                                <option value="อังกฤษเพิ่มเติม">อังกฤษเพิ่มเติม</option>
                            </optgroup>
                            <option value="เคมี">เคมี</option>
                            <option value="การออกแบบและเทคโนโลยี">การออกแบบและเทคโนโลยี</option>
                            <option value="ระบบฐานข้อมูล">ระบบฐานข้อมูล</option>
                            <option value="ประวัติศาสตร์สากล">ประวัติศาสตร์สากล</option>
                            <option value="สุขศึกษา">สุขศึกษา</option>
                            <option value="สังคมศึกษา">สังคมศึกษา</option>
                            <option value="แนะแนว">แนะแนว</option>
                            <option value="ชีววิทยา">ชีววิทยา</option>
                            <option value="วิทยาศาสตร์กายภาพ">วิทยาศาสตร์กายภาพ</option>
                            <option value="การงานอาชีพ">การงานอาชีพ</option>
                            <option value="นาฏศิลป์ไทย">นาฏศิลป์ไทย</option>
                        </select>
                    </div>
                </div>

                <div class="mt-6">
                    <h2 id="subject-list-title" class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-300">เลือกวิชาเพื่อดูงาน</h2>
                    <div id="subject-task-list-container">
                        <!-- Filtered tasks will be rendered here -->
                    </div>
                    <footer class="text-center pt-8 text-xs text-gray-500 dark:text-gray-400">
                        พัฒนาโดย 25486 โรงเรียนหนองไผ่
                    </footer>
                </div>
            </main>
        </div>

        <!-- View for Profile Page -->
        <div id="profile-view" class="hidden">
            <main class="container mx-auto px-4 pb-24 pt-6">
                <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                     <h2 class="text-2xl font-bold mb-4 text-center">โปรไฟล์</h2>
                     <div class="text-center mb-6">
                         <p class="text-gray-600 dark:text-gray-400">คุณกำลังเข้าสู่ระบบด้วย:</p>
                         <p id="user-email-display" class="font-semibold text-lg"></p>
                     </div>
                     <button id="logout-btn" class="w-full px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:ring-red-300">ออกจากระบบ</button>
                </div>
                <footer class="text-center pt-8 text-xs text-gray-500 dark:text-gray-400">
                    พัฒนาโดย 25486 โรงเรียนหนองไผ่
                </footer>
            </main>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg z-20">
            <div class="flex justify-around max-w-xl mx-auto">
                <button id="home-btn" class="nav-btn flex flex-col items-center justify-center w-full pt-3 pb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span class="text-xs mt-1">หน้าหลัก</span>
                </button>
                <button id="subject-btn" class="nav-btn flex flex-col items-center justify-center w-full pt-3 pb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layers-3"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.84l8.57 3.91a2 2 0 0 0 1.66 0l8.57-3.91a1 1 0 0 0 0-1.84Z"/><path d="m22 17.65-8.57-3.91a2 2 0 0 0-1.66 0L3.2 17.65a1 1 0 0 0 0 1.84l8.57 3.91a2 2 0 0 0 1.66 0l8.57-3.91a1 1 0 0 0 0-1.84Z"/><path d="m22 12.65-8.57-3.91a2 2 0 0 0-1.66 0L3.2 12.65a1 1 0 0 0 0 1.84l8.57 3.91a2 2 0 0 0 1.66 0l8.57-3.91a1 1 0 0 0 0-1.84Z"/></svg>
                    <span class="text-xs mt-1">เลือกวิชา</span>
                </button>
                <button id="profile-btn" class="nav-btn flex flex-col items-center justify-center w-full pt-3 pb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>
                    <span class="text-xs mt-1">โปรไฟล์</span>
                </button>
            </div>
        </nav>
    </div>
    
    <!-- MODALS (kept outside app-wrapper) -->
    <div id="add-task-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 p-6 modal">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">เพิ่มงานใหม่</h2>
            <form id="task-form" novalidate>
                <input type="hidden" id="task-id">
                <div class="mb-4">
                    <label for="task-title" class="block mb-2 text-sm font-medium">ชื่องาน</label>
                    <input type="text" id="task-title" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="เช่น การบ้านบทที่ 5" required>
                </div>
                <div class="mb-4">
                    <label for="task-subject" class="block mb-2 text-sm font-medium">วิชา</label>
                    <input type="text" id="task-subject" list="subject-list-data" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="เช่น ฟิสิกส์" required>
                    <datalist id="subject-list-data">
                         <option value="ฟิสิกส์"></option>
                        <option value="ภาษาไทย"></option>
                        <option value="คณิตพื้นฐาน"></option>
                        <option value="คณิตเพิ่มเติม"></option>
                        <option value="อังกฤษพื้นฐาน"></option>
                        <option value="อังกฤษเพิ่มเติม"></option>
                        <option value="เคมี"></option>
                        <option value="การออกแบบและเทคโนโลยี"></option>
                        <option value="ระบบฐานข้อมูล"></option>
                        <option value="ประวัติศาสตร์สากล"></option>
                        <option value="สุขศึกษา"></option>
                        <option value="สังคมศึกษา"></option>
                        <option value="แนะแนว"></option>
                        <option value="ชีววิทยา"></option>
                        <option value="วิทยาศาสตร์กายภาพ"></option>
                        <option value="การงานอาชีพ"></option>
                        <option value="นาฏศิลป์ไทย"></option>
                    </datalist>
                </div>
                <div class="mb-6">
                    <label for="task-due-date" class="block mb-2 text-sm font-medium">กำหนดส่ง (วันและเวลา)</label>
                    <input type="datetime-local" id="task-due-date" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-task-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-delete-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 p-6 modal text-center">
            <h2 class="text-xl font-bold mb-4">ยืนยันการลบ</h2>
            <p id="confirm-delete-message" class="mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบงานนี้?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">ยกเลิก</button>
                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ลบ</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="fixed inset-0 z-[110] flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-1/3 p-6 modal text-center">
            <h2 id="alert-title" class="text-xl font-bold mb-4 text-red-500"></h2>
            <p id="alert-message" class="mb-6"></p>
            <div class="flex justify-center">
                <button id="alert-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ตกลง</button>
            </div>
        </div>
    </div>
    <!-- Terms Modal -->
    <div id="terms-modal" class="fixed inset-0 z-[120] flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 md:w-2/3 max-w-2xl h-3/4 flex flex-col modal">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                <h2 class="text-xl font-bold">ข้อกำหนดและนโยบายความเป็นส่วนตัว</h2>
                <button id="close-terms-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4 text-gray-700 dark:text-gray-300">
                <h3 class="font-semibold text-lg">ยินดีต้อนรับสู่แอปเก็บงาน!</h3>
                <p>เอกสารฉบับนี้อธิบายข้อกำหนดในการให้บริการและนโยบายความเป็นส่วนตัวของเรา การสมัครสมาชิกและใช้งานแอปพลิเคชันนี้ถือว่าคุณได้อ่าน ทำความเข้าใจ และยอมรับข้อกำหนดทั้งหมด</p>
                
                <h4 class="font-semibold pt-2">1. การรวบรวมข้อมูล</h4>
                <p>เราจะรวบรวมข้อมูลที่จำเป็นต่อการให้บริการเท่านั้น ซึ่งรวมถึง:</p>
                <ul class="list-disc list-inside pl-4">
                    <li><strong>ข้อมูลบัญชี:</strong> อีเมลและรหัสผ่านที่คุณใช้ในการสมัครสมาชิก</li>
                    <li><strong>ข้อมูลการใช้งาน:</strong> รายละเอียดของงานที่คุณสร้างขึ้น เช่น ชื่องาน, วิชา, และกำหนดส่ง</li>
                </ul>

                <h4 class="font-semibold pt-2">2. การปกป้องข้อมูลและความปลอดภัย</h4>
                <p>ความปลอดภัยของข้อมูลคุณคือสิ่งที่เราให้ความสำคัญสูงสุด เรามีมาตรการในการปกป้องข้อมูลของคุณดังนี้:</p>
                <ul class="list-disc list-inside pl-4">
                    <li><strong>การเข้ารหัสรหัสผ่าน (Password Hashing):</strong> เราจัดเก็บรหัสผ่านของคุณในรูปแบบที่ผ่านการเข้ารหัสทางเดียว (Hashed) โดยใช้อัลกอริทึมความปลอดภัยที่ทันสมัยและได้มาตรฐานอุตสาหกรรม ซึ่งหมายความว่าแม้แต่ทีมงานของเราก็ไม่สามารถเข้าถึงหรืออ่านรหัสผ่านที่แท้จริงของคุณได้</li>
                    <li><strong>การแยกข้อมูล:</strong> ข้อมูลงานทั้งหมดของคุณจะถูกเชื่อมโยงกับบัญชีของคุณโดยเฉพาะและถูกจัดเก็บแยกจากข้อมูลของผู้ใช้อื่นอย่างชัดเจน เราไม่อนุญาตให้มีการเข้าถึงข้อมูลข้ามบัญชีโดยไม่ได้รับอนุญาต</li>
                    <li><strong>การจัดเก็บข้อมูล (ฉบับจำลอง):</strong> ในเวอร์ชันปัจจุบัน ข้อมูลทั้งหมดของคุณ (รวมถึงข้อมูลบัญชีและงาน) จะถูกจัดเก็บไว้ใน Local Storage ของเบราว์เซอร์บนอุปกรณ์ของคุณเท่านั้น ซึ่งหมายความว่าข้อมูลจะยังคงอยู่บนเครื่องของคุณจนกว่าคุณจะล้างข้อมูลเบราว์เซอร์หรือออกจากระบบ</li>
                </ul>

                <h4 class="font-semibold pt-2">3. การใช้งานข้อมูล</h4>
                <p>เราใช้ข้อมูลของคุณเพื่อวัตถุประสงค์ดังต่อไปนี้:</p>
                <ul class="list-disc list-inside pl-4">
                    <li>เพื่อยืนยันตัวตนและอนุญาตให้คุณเข้าถึงบัญชีส่วนตัวของคุณ</li>
                    <li>เพื่อบันทึก, แสดงผล, และจัดการข้อมูลงานตามที่คุณสั่งการ</li>
                    <li>เพื่อปรับปรุงและพัฒนาการให้บริการของแอปพลิเคชัน</li>
                </ul>
                <p>เราจะไม่เปิดเผย, จำหน่าย, หรือให้เช่าข้อมูลส่วนบุคคลของคุณแก่บุคคลที่สามโดยไม่ได้รับความยินยอมจากคุณ ยกเว้นในกรณีที่กฎหมายกำหนด</p>

                <h4 class="font-semibold pt-2">4. ความรับผิดชอบของผู้ใช้</h4>
                <p>คุณมีหน้าที่รับผิดชอบในการรักษารหัสผ่านของคุณให้เป็นความลับ และรับผิดชอบต่อกิจกรรมทั้งหมดที่เกิดขึ้นภายใต้บัญชีของคุณ หากคุณเชื่อว่าบัญชีของคุณถูกเข้าถึงโดยไม่ได้รับอนุญาต กรุณาติดต่อเราทันที</p>

                <h4 class="font-semibold pt-2">5. การเปลี่ยนแปลงข้อกำหนด</h4>
                <p>เราขอสงวนสิทธิ์ในการปรับปรุงหรือเปลี่ยนแปลงข้อกำหนดในการให้บริการเหล่านี้ได้ตลอดเวลา การเปลี่ยนแปลงจะมีผลทันทีเมื่อมีการเผยแพร่บนแอปพลิเคชัน การที่คุณใช้งานแอปพลิเคชันต่อไปหลังจากการเปลี่ยนแปลง ถือว่าคุณยอมรับข้อกำหนดฉบับใหม่</p>
                <p class="pt-4">ขอขอบคุณที่ไว้วางใจใช้บริการของเรา</p>
            </div>
            <div class="p-4 border-t dark:border-gray-700 text-right bg-gray-50 dark:bg-gray-800">
                 <button id="terms-ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ยอมรับและปิด</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyFHmP8D0DbHhOaVBkLY326ABWgGW4QbFOjDpFc-s2L7eawtEAMrE2k8nOTKs5dr8rlvA/exec";
            
            // --- UI ELEMENTS ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const authView = document.getElementById('auth-view');
            const appWrapper = document.getElementById('app-wrapper');
            const loginFormContainer = document.getElementById('login-form-container');
            const registerFormContainer = document.getElementById('register-form-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register-btn');
            const showLoginBtn = document.getElementById('show-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userEmailDisplay = document.getElementById('user-email-display');
            const registerTermsCheckbox = document.getElementById('register-terms');
            const registerSubmitBtn = document.getElementById('register-submit-btn');
            const openTermsBtn = document.getElementById('open-terms-btn');
            const termsModal = document.getElementById('terms-modal');
            const closeTermsBtn = document.getElementById('close-terms-btn');
            const termsOkBtn = document.getElementById('terms-ok-btn');
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');
            const validSubjects = ["ฟิสิกส์", "ภาษาไทย", "คณิตพื้นฐาน", "คณิตเพิ่มเติม", "อังกฤษพื้นฐาน","อังกฤษเพิ่มเติม", "เคมี", "การออกแบบและเทคโนโลยี", "ระบบฐานข้อมูล", "ประวัติศาสตร์สากล", "สุขศึกษา", "สังคมศึกษา", "แนะแนว", "ชีววิทยา", "วิทยาศาสตร์กายภาพ", "การงานอาชีพ", "นาฏศิลป์ไทย"];
            const homeView = document.getElementById('home-view');
            const subjectView = document.getElementById('subject-view');
            const profileView = document.getElementById('profile-view');
            const calendarWrapper = document.getElementById('calendar-wrapper');
            const taskListContainer = document.getElementById('task-list-container');
            const subjectTaskListContainer = document.getElementById('subject-task-list-container');
            const subjectListTitle = document.getElementById('subject-list-title');
            const openAddTaskModalBtn = document.getElementById('open-add-task-modal-btn');
            const addTaskModal = document.getElementById('add-task-modal');
            const cancelTaskBtn = document.getElementById('cancel-task-btn');
            const taskForm = document.getElementById('task-form');
            const modalTitle = document.getElementById('modal-title');
            const taskIdInput = document.getElementById('task-id');
            const taskTitleInput = document.getElementById('task-title');
            const taskSubjectInput = document.getElementById('task-subject');
            const taskDueDateInput = document.getElementById('task-due-date');
            const homeBtn = document.getElementById('home-btn');
            const subjectBtn = document.getElementById('subject-btn');
            const profileBtn = document.getElementById('profile-btn');
            const searchInput = document.getElementById('search-input');
            const subjectDropdown = document.getElementById('subject-dropdown');
            const confirmDeleteModal = document.getElementById('confirm-delete-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            
            // --- App State ---
            let currentUser = null;
            let tasks = [];
            let calendarDate = new Date();
            let selectedDateFilter = null;
            let currentFilter = 'all';
            let searchTerm = '';
            let taskToDeleteId = null;

            // --- HELPER FUNCTIONS ---
            const showLoader = () => loadingOverlay.classList.remove('hidden');
            const hideLoader = () => loadingOverlay.classList.add('hidden');

            const showAlert = (title, message) => {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                toggleModal(alertModal, true);
            };

            const toggleModal = (modal, show) => {
                modal.classList.toggle('hidden', !show);
            };
            
            const callApi = async (body) => {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        credentials: 'omit',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify(body),
                    });
                    
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return await res.json();

                } catch (error) {
                    console.error('API Call Error:', error);
                    showAlert('Network Error', 'Could not connect to the database. Please check your connection and the SCRIPT_URL.');
                    return { status: 'error', message: error.message };
                }
            };


            // --- AUTH LOGIC ---
            const checkAuth = async () => {
                currentUser = sessionStorage.getItem('currentUser');
                if (currentUser) {
                    showLoader();
                    authView.classList.add('hidden');
                    appWrapper.classList.remove('hidden');
                    userEmailDisplay.textContent = currentUser;
                    await initializeApp();
                } else {
                    authView.classList.remove('hidden');
                    appWrapper.classList.add('hidden');
                }
            };

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoader();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const response = await callApi({ action: 'login', email, password });

                if (response.status === 'success') {
                    sessionStorage.setItem('currentUser', response.userId);
                    // Don't hide loader, checkAuth will handle it via initializeApp
                    await checkAuth();
                } else {
                    showAlert('เกิดข้อผิดพลาด', response.message || 'อีเมลหรือรหัสผ่านไม่ถูกต้อง');
                    hideLoader();
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoader();
                if (!registerTermsCheckbox.checked) {
                    showAlert('เกิดข้อผิดพลาด', 'กรุณายอมรับข้อกำหนดและเงื่อนไข');
                    hideLoader();
                    return;
                }
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;

                if (password !== confirmPassword) {
                    showAlert('เกิดข้อผิดพลาด', 'รหัสผ่านไม่ตรงกัน');
                    hideLoader();
                    return;
                }

                const response = await callApi({ action: 'register', email, password });

                if (response.status === 'success') {
                    showAlert('สำเร็จ', 'สมัครสมาชิกเรียบร้อยแล้ว กรุณาเข้าสู่ระบบ');
                    showLoginBtn.click();
                    registerForm.reset();
                    registerTermsCheckbox.checked = false;
                    registerSubmitBtn.disabled = true;
                } else {
                     showAlert('เกิดข้อผิดพลาด', response.message || 'ไม่สามารถสมัครสมาชิกได้');
                }
                hideLoader();
            });

            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('currentUser');
                currentUser = null;
                tasks = [];
                checkAuth();
            });
            
            // --- MAIN APP INITIALIZATION ---
            const initializeApp = async () => {
                selectedDateFilter = null;
                currentFilter = 'all';
                searchTerm = '';
                await fetchTasks();
                switchView('home');
                hideLoader();
            };

            // --- Calendar Logic ---
            const renderCalendar = () => {
                const tempDate = new Date(calendarDate.getTime());
                tempDate.setDate(1);
                const month = tempDate.getMonth();
                const year = tempDate.getFullYear();

                const firstDayIndex = tempDate.getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                const prevLastDate = new Date(year, month, 0).getDate();
                const lastDayIndex = new Date(year, month, lastDate).getDay();
                const nextDays = 7 - lastDayIndex - 1;
                
                const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                const daysOfWeek = ["อา", "จ", "อ", "พ", "พฤ", "ศ", "ส"];

                const dueDatesThisMonth = new Set(
                    tasks.filter(task => !task.isDone).map(task => {
                        const d = new Date(task.dueDate);
                        return d.getFullYear() === year && d.getMonth() === month ? d.getDate() : null;
                    }).filter(d => d !== null)
                );

                let calendarHTML = `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                            <h3 class="text-lg font-bold">${months[month]} ${year + 543}</h3>
                            <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">${daysOfWeek.map(day => `<div>${day}</div>`).join('')}</div>
                        <div class="grid grid-cols-7 gap-2 text-center">
                `;
                for (let x = firstDayIndex; x > 0; x--) { calendarHTML += `<div class="text-gray-300 dark:text-gray-600">${prevLastDate - x + 1}</div>`; }
                const today = new Date();
                for (let i = 1; i <= lastDate; i++) {
                    let classes = 'w-8 h-8 flex items-center justify-center rounded-full';
                    const fullDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const isToday = i === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                    const hasDueDate = dueDatesThisMonth.has(i);
                    const isSelected = selectedDateFilter === fullDateStr;
                    if (isSelected) { classes += ' ring-2 ring-offset-2 ring-blue-500 dark:ring-offset-gray-900'; }
                    if (hasDueDate) { classes += ' bg-red-500 text-white font-bold cursor-pointer hover:bg-red-600 transition-colors'; } 
                    else if (isToday) { classes += ' bg-blue-500 text-white'; }
                    calendarHTML += `<div class="${classes}" data-date="${fullDateStr}">${i}</div>`;
                }
                for (let j = 1; j <= nextDays; j++) { calendarHTML += `<div class="text-gray-300 dark:text-gray-600">${j}</div>`; }
                calendarHTML += `</div></div>`;
                calendarWrapper.innerHTML = calendarHTML;
            };

            // --- View Switching Logic ---
            const switchView = (viewToShow) => {
                [homeView, subjectView, profileView].forEach(v => v.classList.add('hidden'));
                [homeBtn, subjectBtn, profileBtn].forEach(b => {
                    b.classList.remove('text-blue-600', 'dark:text-blue-400');
                    b.classList.add('text-gray-600', 'dark:text-gray-400');
                });
                
                const setActiveView = (view, button) => {
                    view.classList.remove('hidden');
                    button.classList.add('text-blue-600', 'dark:text-blue-400');
                    button.classList.remove('text-gray-600', 'dark:text-gray-400');
                };

                if (viewToShow === 'home') { setActiveView(homeView, homeBtn); updateHomeView(); } 
                else if (viewToShow === 'subject') {
                    setActiveView(subjectView, subjectBtn);
                    renderSubjectTasks(); 
                    subjectListTitle.textContent = 'เลือกวิชาเพื่อดูงาน';
                    subjectDropdown.value = 'all';
                } else if (viewToShow === 'profile') { setActiveView(profileView, profileBtn); }
            };

            const updateHomeView = () => {
                if (tasks.filter(t => !t.isDone).length > 0) {
                    calendarWrapper.classList.remove('hidden');
                    renderCalendar();
                } else {
                    calendarWrapper.classList.add('hidden');
                    selectedDateFilter = null;
                }
                renderHomePageTasks();
            };
            
            // --- Task Logic ---
            const fetchTasks = async () => {
                if (!currentUser) return;
                const response = await callApi({ action: 'getTasks', userId: currentUser });
                if (response.status === 'success') {
                    tasks = response.tasks;
                }
                // No need to render here, initializeApp will call the render functions
            };
            
            const getRelativeDate = (dateString, isDone) => {
                if (isDone) return `<span class="text-green-500">ทำเสร็จแล้ว</span>`;
                if (!dateString) return '';
                const now = new Date();
                const dueDate = new Date(dateString);
                const diffMs = dueDate - now;
                if (diffMs < 0) return `<span class="text-red-500">เลยกำหนดแล้ว</span>`;
                const d = Math.floor(diffMs / 86400000);
                const h = Math.floor((diffMs % 86400000) / 3600000);
                const m = Math.floor((diffMs % 3600000) / 60000);
                if (d > 0) return `<span>เหลือ ${d} วัน ${h} ชั่วโมง</span>`;
                if (h > 0) return `<span class="text-yellow-500">เหลือ ${h} ชั่วโมง ${m} นาที</span>`;
                if (m > 0) return `<span class="text-orange-500">เหลือ ${m} นาที</span>`;
                return `<span class="text-red-500">ใกล้ถึงกำหนดส่ง</span>`;
            };

            const createTaskCardHTML = (task) => {
                const dueDate = new Date(task.dueDate);
                const date = dueDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                const time = dueDate.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-3 flex items-start task-card ${task.isDone ? 'task-done' : ''}">
                        <input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.isDone ? 'checked' : ''}>
                        <div class="flex-grow">
                             <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg task-title">${task.title}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${task.subject}</p>
                                    <p class="text-sm mt-2">${getRelativeDate(task.dueDate, task.isDone)}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${date}, ${time} น.</p>
                                </div>
                                <div class="flex items-center gap-1 pl-2">
                                     <button data-id="${task.id}" class="edit-btn p-2 text-gray-500 hover:text-blue-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                                     <button data-id="${task.id}" class="delete-btn p-2 text-gray-500 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            const renderHomePageTasks = () => {
                taskListContainer.innerHTML = '';
                const now = new Date();
                if (selectedDateFilter) {
                    const selectedDate = new Date(selectedDateFilter);
                    const tasksOnDate = tasks.filter(t => new Date(t.dueDate).toDateString() === selectedDate.toDateString()).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
                    let html = `
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-700 dark:text-gray-300">งานวันที่ ${selectedDate.toLocaleDateString('th-TH', { day: 'numeric', month: 'long' })} (${tasksOnDate.length})</h2>
                            <button id="clear-date-filter" class="text-sm text-blue-600 hover:underline">แสดงทั้งหมด</button>
                        </div>
                        ${tasksOnDate.map(createTaskCardHTML).join('') || `<p class="text-center text-gray-500 dark:text-gray-400 mt-4">ไม่มีงานที่ต้องส่งในวันนี้</p>`}`;
                    taskListContainer.innerHTML = html;
                    document.getElementById('clear-date-filter').addEventListener('click', () => { selectedDateFilter = null; updateHomeView(); });
                } else {
                    const overdue = tasks.filter(t => !t.isDone && new Date(t.dueDate) < now).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                    const todo = tasks.filter(t => !t.isDone && new Date(t.dueDate) >= now).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                    const done = tasks.filter(t => t.isDone).sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
                    const renderSection = (title, arr) => arr.length === 0 ? '' : `<div class="mb-6"><h2 class="text-xl font-bold text-gray-700 dark:text-gray-300 mb-3">${title} (${arr.length})</h2>${arr.map(createTaskCardHTML).join('')}</div>`;
                    let allHTML = renderSection('เลยกำหนด', overdue) + renderSection('งานที่ต้องทำ', todo) + renderSection('เสร็จแล้ว', done);
                    if (allHTML === '') {
                        taskListContainer.innerHTML = `<div class="text-center mt-10 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-check mx-auto mb-4 text-green-500"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg><h3 class="text-xl font-semibold">ไม่มีงานค้าง!</h3><p class="text-gray-500 dark:text-gray-400 mt-2">ยอดเยี่ยมมาก! เพิ่มงานใหม่ได้เลย</p></div>`;
                    } else { taskListContainer.innerHTML = allHTML; }
                }
                const footerHTML = `<footer class="text-center pt-8 text-xs text-gray-500 dark:text-gray-400">พัฒนาโดย 25486 โรงเรียนหนองไผ่</footer>`;
                taskListContainer.insertAdjacentHTML('beforeend', footerHTML);
            };
            
            const renderSubjectTasks = () => {
                 const filtered = tasks.filter(t => (currentFilter === 'all' || t.subject === currentFilter) && (!searchTerm || t.title.toLowerCase().includes(searchTerm.toLowerCase()) || t.subject.toLowerCase().includes(searchTerm.toLowerCase()))).sort((a, b) => (a.isDone - b.isDone) || (new Date(a.dueDate) - new Date(b.dueDate)));
                if (filtered.length > 0) { subjectTaskListContainer.innerHTML = filtered.map(createTaskCardHTML).join(''); } 
                else { subjectTaskListContainer.innerHTML = `<div class="text-center p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder-search mx-auto mb-4 text-gray-400"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><circle cx="14.5" cy="13.5" r="2.5"/><path d="M16.5 15.5 18 17"/></svg><h3 class="text-xl font-semibold">ไม่มีงาน</h3><p class="text-gray-500 dark:text-gray-400 mt-2">ไม่พบงานในหมวดหมู่นี้</p></div>`; }
            }

            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const subject = taskSubjectInput.value.trim();
                if (!validSubjects.includes(subject)) {
                    showAlert('วิชาไม่ถูกต้อง', `ไม่พบวิชา "${subject}" ในระบบ`);
                    return;
                }
                const id = taskIdInput.value;
                
                let taskData;
                let originalTasks = JSON.parse(JSON.stringify(tasks));

                // Optimistic UI Update
                if (id) {
                    const taskIndex = tasks.findIndex(t => t.id.toString() === id.toString());
                    if (taskIndex > -1) {
                        taskData = { ...tasks[taskIndex], title: taskTitleInput.value.trim(), subject, dueDate: taskDueDateInput.value };
                        tasks[taskIndex] = taskData;
                    }
                } else {
                    taskData = { 
                        id: Date.now(), 
                        ownerId: currentUser,
                        title: taskTitleInput.value.trim(), 
                        subject, 
                        dueDate: taskDueDateInput.value,
                        isDone: false
                    };
                    tasks.push(taskData);
                }
                
                updateHomeView();
                toggleModal(addTaskModal, false);

                // Sync to DB in background
                const apiAction = id ? 'updateTask' : 'addTask';
                callApi({ action: apiAction, task: taskData }).then(async (response) => {
                    if (response.status !== 'success') {
                        showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกได้ กำลังซิงค์ข้อมูลล่าสุด');
                        showLoader();
                        await fetchTasks();
                        updateHomeView();
                        hideLoader();
                    }
                });
            });
            
            document.body.addEventListener('change', (e) => {
                 const checkbox = e.target.closest('.task-checkbox');
                 if (checkbox) {
                    const taskId = checkbox.dataset.id;
                    const taskIndex = tasks.findIndex(t => t.id.toString() === taskId);
                    if (taskIndex > -1) {
                        const originalStatus = tasks[taskIndex].isDone;
                        tasks[taskIndex].isDone = checkbox.checked;
                        updateHomeView(); // Optimistic update

                        // Sync to DB in background
                        callApi({ action: 'updateTask', task: tasks[taskIndex] }).then(async (response) => {
                           if (response.status !== 'success') {
                               showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถอัปเดตได้ กำลังซิงค์ข้อมูลล่าสุด');
                               showLoader();
                               await fetchTasks();
                               updateHomeView();
                               hideLoader();
                           }
                        });
                    }
                 }
            });

            confirmDeleteBtn.addEventListener('click', (e) => {
                if (taskToDeleteId) {
                    const taskIndex = tasks.findIndex(t => t.id.toString() === taskToDeleteId);
                    if (taskIndex > -1) {
                        const deletedTaskId = taskToDeleteId;
                        
                        // Optimistic UI Update
                        tasks.splice(taskIndex, 1);
                        updateHomeView();
                        toggleModal(confirmDeleteModal, false);
                        taskToDeleteId = null;

                        // Sync to DB in background
                        callApi({ action: 'deleteTask', taskId: deletedTaskId }).then(async (response) => {
                            if (response.status !== 'success') {
                                showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถลบได้ กำลังซิงค์ข้อมูลล่าสุด');
                                showLoader();
                                await fetchTasks();
                                updateHomeView();
                                hideLoader();
                            }
                        });
                    }
                }
            });

            document.body.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) { taskToDeleteId = deleteBtn.dataset.id; toggleModal(confirmDeleteModal, true); }
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    const task = tasks.find(t => t.id.toString() === editBtn.dataset.id);
                    if (task) {
                        modalTitle.textContent = 'แก้ไขงาน';
                        taskIdInput.value = task.id; 
                        taskTitleInput.value = task.title;
                        taskSubjectInput.value = task.subject; 
                        taskDueDateInput.value = task.dueDate;
                        toggleModal(addTaskModal, true);
                    }
                }
            });

            // --- Other Event Listeners ---
            homeBtn.addEventListener('click', () => { selectedDateFilter = null; switchView('home'); });
            subjectBtn.addEventListener('click', () => switchView('subject'));
            profileBtn.addEventListener('click', () => switchView('profile'));
            showRegisterBtn.addEventListener('click', () => { loginFormContainer.classList.add('hidden'); registerFormContainer.classList.remove('hidden'); });
            showLoginBtn.addEventListener('click', () => { registerFormContainer.classList.add('hidden'); loginFormContainer.classList.remove('hidden'); });
            openAddTaskModalBtn.addEventListener('click', () => { modalTitle.textContent = 'เพิ่มงานใหม่'; taskForm.reset(); taskIdInput.value = ''; toggleModal(addTaskModal, true); });
            cancelTaskBtn.addEventListener('click', () => toggleModal(addTaskModal, false));
            addTaskModal.addEventListener('click', (e) => { if(e.target === addTaskModal) toggleModal(addTaskModal, false); });
            alertOkBtn.addEventListener('click', () => toggleModal(alertModal, false));
            alertModal.addEventListener('click', (e) => { if(e.target === alertModal) toggleModal(alertModal, false); });
            openTermsBtn.addEventListener('click', () => toggleModal(termsModal, true));
            closeTermsBtn.addEventListener('click', () => toggleModal(termsModal, false));
            termsOkBtn.addEventListener('click', () => toggleModal(termsModal, false));
            termsModal.addEventListener('click', (e) => { if (e.target === termsModal) toggleModal(termsModal, false); });
            cancelDeleteBtn.addEventListener('click', () => { toggleModal(confirmDeleteModal, false); taskToDeleteId = null; });
            confirmDeleteModal.addEventListener('click', (e) => { if(e.target === confirmDeleteModal) { toggleModal(confirmDeleteModal, false); taskToDeleteId = null; } });
            registerTermsCheckbox.addEventListener('change', () => { registerSubmitBtn.disabled = !registerTermsCheckbox.checked; registerSubmitBtn.classList.toggle('cursor-not-allowed', !registerTermsCheckbox.checked); });
            calendarWrapper.addEventListener('click', (e) => {
                const prevBtn = e.target.closest('#prev-month');
                const nextBtn = e.target.closest('#next-month');
                if (prevBtn) { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); }
                if (nextBtn) { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); }
                const dayEl = e.target.closest('[data-date]');
                if (dayEl && dayEl.classList.contains('bg-red-500')) {
                    const selectedDate = dayEl.dataset.date;
                    selectedDateFilter = selectedDateFilter === selectedDate ? null : selectedDate;
                    updateHomeView();
                }
            });
            subjectDropdown.addEventListener('change', (e) => { currentFilter = e.target.value; searchTerm = ''; searchInput.value = ''; subjectListTitle.textContent = `งานในวิชา: ${currentFilter === 'all' ? 'ทั้งหมด' : currentFilter}`; renderSubjectTasks(); });
            searchInput.addEventListener('input', (e) => { searchTerm = e.target.value; currentFilter = 'all'; subjectDropdown.value = 'all';  subjectListTitle.textContent = searchTerm ? `ผลการค้นหาสำหรับ: "${searchTerm}"` : 'เลือกวิchaเพื่อดูงาน'; renderSubjectTasks(); });
            
            // --- Initial Load ---
            checkAuth();
        });
    </script>
</body>
</html>

